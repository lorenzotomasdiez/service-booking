---
name: Refactor Docker Compose Files into Modular Structure
status: closed
created: 2025-10-10T11:16:30Z
updated: 2025-10-10T18:57:41Z
completed: 2025-10-10T18:15:00Z
closed: 2025-10-10T18:57:41Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/2
depends_on: []
parallel: false
conflicts_with: []
last_sync: 2025-10-10T18:56:54Z
completion: 100
---

# Task: Refactor Docker Compose Files into Modular Structure

## Description

Consolidate the existing 3 docker-compose files (`docker-compose.yml`, `docker-compose.dev.yml`, `docker-compose.production.yml`) into a standardized modular structure with 6 compose files following Docker best practices. This includes eliminating duplication, pinning all image versions, adding comprehensive health checks, and organizing configs into the `docker/` directory.

**Current State**:
- 3 docker-compose files with significant duplication
- Some services using `:latest` tags
- Inconsistent health checks
- Config files scattered

**Target State**:
- 6 modular docker-compose files in `docker/` directory
- All images version-pinned (no `:latest`)
- Comprehensive health checks for all services
- PostgreSQL upgraded from 15 → 16
- Standardized naming conventions
- Resource limits configured
- Organized config files in `docker/configs/`

## Acceptance Criteria

- [ ] Created `docker/docker-compose.yml` (base: postgres, redis, nginx)
- [ ] Created `docker/docker-compose.dev.yml` (development overrides with hot reload)
- [ ] Created `docker/docker-compose.prod.yml` (production configuration)
- [ ] Created `docker/docker-compose.monitoring.yml` (monitoring stack placeholder)
- [ ] Created `docker/docker-compose.mocks.yml` (Argentina mocks placeholder)
- [ ] Created `docker/docker-compose.test.yml` (testing environment)
- [ ] All images use specific versions (e.g., `postgres:16-alpine`, `redis:7-alpine`)
- [ ] PostgreSQL upgraded to version 16
- [ ] Health checks configured for: postgres, redis, nginx, backend, frontend, pgadmin, redis-commander
- [ ] Resource limits (memory, CPU) set for all services
- [ ] Consistent naming: `barberpro-<service>-<env>` pattern
- [ ] Environment variable hierarchy: `.env` → `docker-compose.yml` → service-specific
- [ ] Moved existing configs to `docker/configs/` (nginx.conf, redis.conf, postgres.conf)
- [ ] Created comprehensive `.env.example` with all variables documented
- [ ] Verified services start successfully with `docker-compose -f docker/docker-compose.yml -f docker/docker-compose.dev.yml up`
- [ ] No duplication between compose files
- [ ] Backward compatibility maintained (npm scripts still work)

## Technical Details

**Files to Refactor**:
- `docker-compose.yml` → `docker/docker-compose.yml`
- `docker-compose.dev.yml` → `docker/docker-compose.dev.yml`
- `docker-compose.production.yml` → `docker/docker-compose.prod.yml`

**New Directory Structure**:
```
docker/
├── docker-compose.yml              # Base configuration
├── docker-compose.dev.yml          # Development overrides
├── docker-compose.prod.yml         # Production overrides
├── docker-compose.monitoring.yml   # Monitoring stack (Phase 3)
├── docker-compose.mocks.yml        # Argentina mocks (Phase 2)
├── docker-compose.test.yml         # Testing environment
├── .env.example                    # Environment variable template
└── configs/                        # Existing configs (move here)
    ├── nginx.conf
    ├── nginx-prod.conf
    ├── nginx-frontend.conf
    ├── redis.conf
    ├── redis-prod.conf
    ├── postgres-prod.conf
    └── proxy_params.conf
```

**Key Implementation Steps**:
1. Create `docker/` directory structure
2. Analyze existing 3 compose files, extract common base config
3. Create `docker-compose.yml` with shared services (postgres, redis, nginx)
4. Create `docker-compose.dev.yml` with development overrides
5. Pin all image versions
6. Upgrade PostgreSQL 15 → 16
7. Add comprehensive health checks
8. Configure resource limits
9. Move config files to `docker/configs/`
10. Update volume paths and network names
11. Create `.env.example` with documentation
12. Test composition works: `docker-compose -f docker/docker-compose.yml -f docker/docker-compose.dev.yml up`

**Health Check Examples**:
```yaml
# PostgreSQL
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U barberpro -d barberpro_dev"]
  interval: 10s
  timeout: 5s
  retries: 5

# Redis
healthcheck:
  test: ["CMD", "redis-cli", "ping"]
  interval: 10s
  timeout: 5s
  retries: 5

# Backend
healthcheck:
  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

**Resource Limits**:
```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
    reservations:
      cpus: '0.25'
      memory: 256M
```

## Dependencies

- [ ] Docker Desktop or Docker Engine 20.10+ installed
- [ ] Docker Compose V2 installed
- [ ] Existing docker-compose files (already present)
- [ ] Backend /health endpoint (should exist, verify)
- [ ] Prisma migrations compatible with PostgreSQL 16

## Effort Estimate

- **Size**: M
- **Hours**: 8-12 hours
- **Parallel**: false (foundation for all other tasks)

**Breakdown**:
- Analysis and planning: 1-2 hours
- Base compose file creation: 2-3 hours
- Dev/prod overrides: 2-3 hours
- Health checks and resource limits: 1-2 hours
- Testing and validation: 2 hours

## Definition of Done

- [ ] All 6 docker-compose files created in `docker/` directory
- [ ] Services start successfully with `docker-compose up`
- [ ] All health checks pass within 60 seconds
- [ ] PostgreSQL 16 runs successfully with existing schema
- [ ] No image uses `:latest` tag
- [ ] `.env.example` documents all required variables
- [ ] Config files organized in `docker/configs/`
- [ ] Documentation updated in `docker/README.md` (basic structure)
- [ ] Code reviewed by DevOps engineer
- [ ] Tested on at least 2 platforms (macOS/Linux)

## Notes

**PostgreSQL Upgrade Path**:
- PostgreSQL 15 → 16 should be seamless for most cases
- Prisma migrations handle version differences
- Test migration: `docker-compose exec postgres psql --version`
- If issues, document rollback plan in `docker/README.md`

**Backward Compatibility**:
- Keep root-level docker-compose files as symlinks to `docker/` versions initially
- Update npm scripts to point to new locations
- Announce changes to team before removing old files
