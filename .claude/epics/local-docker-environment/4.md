---
name: Build MercadoPago Mock Server
status: closed
created: 2025-10-10T11:16:30Z
updated: 2025-10-12T01:28:16Z
closed: 2025-10-12T01:28:16Z
last_sync: 2025-10-12T01:25:10Z
completion: 100
github: https://github.com/lorenzotomasdiez/service-booking/issues/4
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Build MercadoPago Mock Server

## Description

Create a lightweight Express.js mock server that simulates the MercadoPago payment gateway API for local development and testing. The mock should support all payment methods used in Argentina (cards, wallets, BNPL, Rapipago, PagoFacil) with configurable response scenarios, webhook simulation, and a simple web UI for scenario management.

**Goal**: Enable complete payment flow testing without external MercadoPago sandbox dependency.

## Acceptance Criteria

- [ ] Express.js server created in `docker/mocks/mercadopago/`
- [ ] Mirrors key MercadoPago API endpoints:
  - POST `/v1/payments` - Create payment
  - GET `/v1/payments/:id` - Get payment status
  - POST `/v1/payments/:id/refunds` - Process refund
  - GET `/v1/payment_methods` - List payment methods
- [ ] Configurable response scenarios via `scenarios.json`:
  - Success (approved)
  - Pending
  - Rejected
  - Timeout
  - Network error
- [ ] Webhook simulation with configurable delays
- [ ] Transaction history storage (in-memory)
- [ ] Payment status transitions (pending → approved/rejected)
- [ ] Installment calculation support
- [ ] Simple web UI at `/dashboard` for scenario management
- [ ] Swagger/OpenAPI documentation at `/docs`
- [ ] Docker health check endpoint at `/health`
- [ ] Structured JSON logging
- [ ] Request/response logging for debugging
- [ ] Environment variable configuration
- [ ] Unit tests for core logic (payment validation, status transitions)

## Technical Details

**Directory Structure**:
```
docker/mocks/mercadopago/
├── package.json
├── index.js                # Express server entry point
├── routes/
│   ├── payments.js        # Payment endpoints
│   ├── refunds.js         # Refund endpoints
│   └── webhooks.js        # Webhook simulation
├── services/
│   ├── payment.service.js # Payment logic
│   └── webhook.service.js # Webhook delivery
├── config/
│   └── scenarios.json     # Response scenarios
├── public/
│   └── dashboard.html     # Simple UI
├── tests/
│   └── payment.test.js
├── Dockerfile
└── README.md
```

**Scenarios Configuration** (`scenarios.json`):
```json
{
  "default": "success",
  "scenarios": {
    "success": {
      "status": "approved",
      "status_detail": "accredited",
      "delay_ms": 500
    },
    "pending": {
      "status": "pending",
      "status_detail": "pending_waiting_payment",
      "delay_ms": 1000
    },
    "rejected": {
      "status": "rejected",
      "status_detail": "cc_rejected_insufficient_amount",
      "delay_ms": 500
    },
    "timeout": {
      "simulate_timeout": true,
      "delay_ms": 30000
    }
  }
}
```

**API Endpoints**:

```javascript
// POST /v1/payments
app.post('/v1/payments', async (req, res) => {
  const scenario = loadScenario(req.query.scenario || 'default');
  await sleep(scenario.delay_ms);

  const payment = {
    id: generateId(),
    status: scenario.status,
    status_detail: scenario.status_detail,
    transaction_amount: req.body.transaction_amount,
    payer: req.body.payer,
    payment_method_id: req.body.payment_method_id,
    installments: req.body.installments || 1,
    date_created: new Date().toISOString(),
    ...
  };

  storePayment(payment);
  triggerWebhook(payment); // Async

  res.json(payment);
});
```

**Dockerfile**:
```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3001

HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1

CMD ["node", "index.js"]
```

**Web Dashboard** (`dashboard.html`):
- Simple HTML interface to:
  - View active scenarios
  - Switch default scenario
  - View recent transactions
  - Trigger webhook manually
  - Clear transaction history

## Dependencies

- [ ] Task 2 completed (docker structure in place)
- [ ] Node.js 20+ Docker image
- [ ] Express.js, body-parser, cors, winston (logging)

## Effort Estimate

- **Size**: M
- **Hours**: 10-12 hours
- **Parallel**: true (independent of other mocks)

**Breakdown**:
- Project setup and structure: 1-2 hours
- Payment endpoints implementation: 3-4 hours
- Scenario configuration system: 2 hours
- Webhook simulation: 2 hours
- Web dashboard: 1-2 hours
- Tests and documentation: 2 hours

## Definition of Done

- [ ] Server runs on port 3001 in Docker container
- [ ] All CRUD endpoints functional
- [ ] Scenarios configurable via JSON
- [ ] Webhooks deliver to configurable URL
- [ ] Dashboard accessible and functional
- [ ] Swagger docs at `/docs`
- [ ] Health check passes
- [ ] Unit tests pass (>70% coverage)
- [ ] README with API documentation
- [ ] Postman collection for testing
- [ ] Integrated into `docker-compose.mocks.yml`
- [ ] Tested with main BarberPro app

## Notes

**MercadoPago API Compatibility**:
- Focus on common payment flows used in BarberPro
- Don't replicate 100% of MercadoPago API (only what we use)
- Document differences from real API in README

**Webhook Testing**:
```javascript
// Webhook payload simulation
const webhook = {
  action: 'payment.updated',
  api_version: 'v1',
  data: {
    id: payment.id
  },
  date_created: new Date().toISOString(),
  id: generateId(),
  type: 'payment'
};

// POST to configured webhook URL
axios.post(process.env.WEBHOOK_URL, webhook);
```

**Environment Variables**:
```
MERCADOPAGO_MOCK_PORT=3001
MERCADOPAGO_MOCK_WEBHOOK_URL=http://backend:3000/api/webhooks/mercadopago
MERCADOPAGO_MOCK_DEFAULT_SCENARIO=success
```
