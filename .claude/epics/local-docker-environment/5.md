---
name: Build AFIP Mock Server
status: in_progress
created: 2025-10-10T11:16:30Z
updated: 2025-10-12T01:36:59Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/5
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Build AFIP Mock Server

## Description

Create an Express.js mock server that simulates AFIP (Argentina Federal Tax Authority) WebServices for local development. The mock should handle CUIT/CUIL validation, electronic invoice (Factura Electrónica) generation, CAE (Código de Autorización Electrónico) generation, and tax category validation. Use SQLite for persistent storage of mock invoices.

**Goal**: Enable local testing of tax compliance features without AFIP homologation environment.

## Acceptance Criteria

- [ ] Express.js server created in `docker/mocks/afip/`
- [ ] Key AFIP WebService endpoints simulated:
  - POST `/wsaa/auth` - Authentication (mock)
  - POST `/wsfev1/FECAESolicitar` - Request CAE for invoice
  - GET `/wsfev1/FECompUltimoAutorizado` - Get last authorized invoice number
  - POST `/wsfev1/FEParamGetPtosVenta` - Get POS (punto de venta) list
  - POST `/ws_sr_padron_a5/getPersona` - Validate CUIT/CUIL
- [ ] CUIT/CUIL validation with checksum verification
- [ ] CAE generation algorithm (mock but realistic format)
- [ ] Electronic invoice number sequencing per POS
- [ ] SQLite database for storing mock invoices
- [ ] IVA (VAT) calculation logic
- [ ] Tax category validation (Responsable Inscripto, Monotributo, etc.)
- [ ] Configurable validation rules via `rules.json`
- [ ] Health check endpoint at `/health`
- [ ] Swagger/OpenAPI documentation at `/docs`
- [ ] Structured JSON logging
- [ ] Environment variable configuration
- [ ] Unit tests for validation logic

## Technical Details

**Directory Structure**:
```
docker/mocks/afip/
├── package.json
├── index.js              # Express server
├── routes/
│   ├── auth.js          # WSAA authentication mock
│   ├── invoice.js       # Invoice endpoints
│   └── validation.js    # CUIT/CUIL validation
├── services/
│   ├── cae.service.js   # CAE generation
│   ├── cuit.service.js  # CUIT validation
│   └── invoice.service.js # Invoice logic
├── database/
│   ├── db.js            # SQLite connection
│   └── schema.sql       # Database schema
├── config/
│   └── rules.json       # Validation rules
├── tests/
│   ├── cuit.test.js
│   └── invoice.test.js
├── Dockerfile
└── README.md
```

**CUIT/CUIL Validation**:
```javascript
// CUIT format: XX-XXXXXXXX-X (11 digits)
function validateCUIT(cuit) {
  const cleaned = cuit.replace(/[-]/g, '');
  if (cleaned.length !== 11) return false;

  // Checksum validation
  const weights = [5, 4, 3, 2, 7, 6, 5, 4, 3, 2];
  let sum = 0;
  for (let i = 0; i < 10; i++) {
    sum += parseInt(cleaned[i]) * weights[i];
  }
  const checkDigit = (11 - (sum % 11)) % 11;

  return checkDigit === parseInt(cleaned[10]);
}
```

**CAE Generation** (Mock):
```javascript
// CAE format: 14 digits (YYYYMMDDXXXXXX)
function generateCAE() {
  const date = new Date();
  const yyyymmdd = date.toISOString().split('T')[0].replace(/-/g, '');
  const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
  return yyyymmdd + random;
}

// CAE expiration: 10 days from generation
function getCAEExpiration() {
  const date = new Date();
  date.setDate(date.getDate() + 10);
  return date.toISOString().split('T')[0].replace(/-/g, '');
}
```

**SQLite Schema**:
```sql
CREATE TABLE invoices (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  cae TEXT NOT NULL,
  cae_expiration TEXT NOT NULL,
  invoice_number INTEGER NOT NULL,
  pos INTEGER NOT NULL,
  invoice_date TEXT NOT NULL,
  total_amount REAL NOT NULL,
  iva_amount REAL NOT NULL,
  cuit_emisor TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_cae ON invoices(cae);
CREATE UNIQUE INDEX idx_invoice ON invoices(pos, invoice_number);
```

**API Response Example**:
```javascript
// POST /wsfev1/FECAESolicitar
{
  "FECAESolicitarResult": {
    "CAE": "20251010123456",
    "CAEFchVto": "20251020",
    "Resultado": "A",  // A = Approved
    "Observaciones": []
  }
}
```

**Validation Rules** (`rules.json`):
```json
{
  "tax_categories": {
    "1": { "name": "IVA Responsable Inscripto", "iva_rate": 0.21 },
    "6": { "name": "Monotributo", "iva_rate": 0.0 },
    "4": { "name": "Exento", "iva_rate": 0.0 }
  },
  "invoice_types": {
    "1": { "name": "Factura A" },
    "6": { "name": "Factura B" },
    "11": { "name": "Factura C" }
  }
}
```

**Dockerfile**:
```dockerfile
FROM node:20-alpine

WORKDIR /app

RUN apk add --no-cache sqlite

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3002

HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3002/health || exit 1

CMD ["node", "index.js"]
```

## Dependencies

- [ ] Task 2 completed (docker structure)
- [ ] Node.js 20+ Docker image with SQLite support
- [ ] Express.js, sqlite3, body-parser, winston

## Effort Estimate

- **Size**: M
- **Hours**: 10-12 hours
- **Parallel**: true (independent of other mocks)

**Breakdown**:
- Project setup: 1-2 hours
- CUIT validation logic: 2 hours
- CAE generation and invoice endpoints: 3-4 hours
- SQLite database setup: 2 hours
- Validation rules system: 1-2 hours
- Tests and documentation: 2 hours

## Definition of Done

- [ ] Server runs on port 3002 in Docker container
- [ ] CUIT/CUIL validation works correctly
- [ ] CAE generation produces realistic codes
- [ ] Invoice sequencing per POS works
- [ ] SQLite database persists data
- [ ] IVA calculations accurate
- [ ] Swagger docs at `/docs`
- [ ] Health check passes
- [ ] Unit tests pass (>70% coverage for validation logic)
- [ ] README with AFIP endpoint documentation
- [ ] Integrated into `docker-compose.mocks.yml`
- [ ] Tested with main BarberPro app

## Notes

**AFIP Compliance Note**:
- This is a MOCK for development only
- Real AFIP integration requires:
  - Homologation certificate
  - WSAA authentication with real credentials
  - Different endpoints for production
- Document differences in README

**Test CUIT Numbers**:
Provide test CUIT numbers in README:
```
Valid test CUITs:
- 20-12345678-9 (valid checksum)
- 27-98765432-1 (valid checksum)

Invalid test CUITs:
- 20-12345678-0 (invalid checksum)
- 99-99999999-9 (invalid format)
```

**Environment Variables**:
```
AFIP_MOCK_PORT=3002
AFIP_MOCK_DB_PATH=/app/data/afip.db
AFIP_MOCK_DEFAULT_POS=1
```
