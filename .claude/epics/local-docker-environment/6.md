---
name: Build WhatsApp & SMS Mock Servers
status: completed
created: 2025-10-10T11:16:30Z
updated: 2025-10-12T02:40:00Z
completed: 2025-10-12T02:40:00Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/6
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Build WhatsApp & SMS Mock Servers

## Description

Create two lightweight Express.js mock servers: one for WhatsApp Business API and one for SMS gateway (Twilio-style). These mocks enable local testing of messaging features without external service dependencies. Both mocks include message history tracking, webhook callbacks, and simple web UIs for viewing sent messages.

**Goal**: Complete local testing of WhatsApp and SMS notification workflows.

## Acceptance Criteria

**WhatsApp Mock**:
- [ ] Express.js server created in `docker/mocks/whatsapp/`
- [ ] Key endpoints:
  - POST `/v1/messages` - Send message
  - POST `/v1/messages/template` - Send template message
  - POST `/v1/media` - Upload media
  - GET `/v1/messages/:id` - Get message status
- [ ] Webhook callbacks simulation (delivered, read, failed)
- [ ] Template message support
- [ ] Media message support (images, documents)
- [ ] Message status tracking
- [ ] In-memory message history
- [ ] Web UI at `/dashboard` showing sent messages (chat-like interface)
- [ ] Health check at `/health`
- [ ] Runs on port 3003

**SMS Mock**:
- [ ] Express.js server created in `docker/mocks/sms/`
- [ ] Key endpoints:
  - POST `/v1/sms` - Send SMS
  - GET `/v1/sms/:id` - Get SMS status
  - POST `/v1/sms/bulk` - Send bulk SMS
- [ ] Phone number validation (Argentina +54 format)
- [ ] Delivery status simulation
- [ ] Cost calculation (mock)
- [ ] Webhook callbacks
- [ ] In-memory SMS history
- [ ] Web UI at `/dashboard` showing sent SMS
- [ ] Health check at `/health`
- [ ] Runs on port 3004

**Both Servers**:
- [ ] Structured JSON logging
- [ ] Swagger/OpenAPI docs at `/docs`
- [ ] Docker health checks
- [ ] Environment variable configuration
- [ ] Unit tests for core logic

## Technical Details

**WhatsApp Mock Structure**:
```
docker/mocks/whatsapp/
├── package.json
├── index.js
├── routes/
│   ├── messages.js
│   └── webhooks.js
├── services/
│   ├── message.service.js
│   └── webhook.service.js
├── public/
│   └── dashboard.html
├── tests/
│   └── message.test.js
├── Dockerfile
└── README.md
```

**WhatsApp API Example**:
```javascript
// POST /v1/messages
app.post('/v1/messages', async (req, res) => {
  const message = {
    id: generateId(),
    to: req.body.to,
    body: req.body.body,
    type: req.body.type || 'text',
    status: 'sent',
    timestamp: new Date().toISOString()
  };

  // Store message
  messageStore.push(message);

  // Simulate delivery after delay
  setTimeout(() => {
    message.status = 'delivered';
    triggerWebhook('delivered', message);
  }, 1000);

  // Simulate read after additional delay
  setTimeout(() => {
    message.status = 'read';
    triggerWebhook('read', message);
  }, 5000);

  res.json(message);
});
```

**SMS Mock Structure**:
```
docker/mocks/sms/
├── package.json
├── index.js
├── routes/
│   └── sms.js
├── services/
│   ├── sms.service.js
│   └── validation.service.js
├── public/
│   └── dashboard.html
├── tests/
│   └── sms.test.js
├── Dockerfile
└── README.md
```

**SMS API Example**:
```javascript
// POST /v1/sms
app.post('/v1/sms', async (req, res) => {
  // Validate Argentina phone format
  const phoneRegex = /^\+54\s?9?\s?\d{2}\s?\d{4}-?\d{4}$/;
  if (!phoneRegex.test(req.body.to)) {
    return res.status(400).json({
      error: 'Invalid phone format. Use: +54 9 11 1234-5678'
    });
  }

  const sms = {
    id: generateId(),
    to: req.body.to,
    body: req.body.body,
    status: 'queued',
    segments: Math.ceil(req.body.body.length / 160),
    cost: calculateCost(req.body.body),
    timestamp: new Date().toISOString()
  };

  smsStore.push(sms);

  // Simulate delivery
  setTimeout(() => {
    sms.status = 'delivered';
    triggerWebhook('delivered', sms);
  }, 2000);

  res.json(sms);
});

function calculateCost(message) {
  const segments = Math.ceil(message.length / 160);
  const costPerSegment = 0.05; // Mock cost in ARS
  return segments * costPerSegment;
}
```

**Dashboard HTML** (Simple Example):
```html
<!DOCTYPE html>
<html>
<head>
  <title>WhatsApp/SMS Mock Dashboard</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .message { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    .delivered { background: #d4edda; }
    .failed { background: #f8d7da; }
  </style>
</head>
<body>
  <h1>Sent Messages</h1>
  <div id="messages"></div>
  <script>
    async function loadMessages() {
      const res = await fetch('/api/messages');
      const messages = await res.json();
      document.getElementById('messages').innerHTML = messages.map(m => `
        <div class="message ${m.status}">
          <strong>To:</strong> ${m.to}<br>
          <strong>Status:</strong> ${m.status}<br>
          <strong>Body:</strong> ${m.body}<br>
          <small>${new Date(m.timestamp).toLocaleString()}</small>
        </div>
      `).join('');
    }
    setInterval(loadMessages, 3000);
    loadMessages();
  </script>
</body>
</html>
```

**Dockerfiles** (Similar for both):
```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3003  # or 3004 for SMS

HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3003/health || exit 1

CMD ["node", "index.js"]
```

## Dependencies

- [ ] Task 2 completed (docker structure)
- [ ] Node.js 20+ Docker image
- [ ] Express.js, body-parser, cors, winston

## Effort Estimate

- **Size**: M
- **Hours**: 10-12 hours (both servers combined)
- **Parallel**: true (independent of other mocks)

**Breakdown**:
- WhatsApp mock: 5-6 hours
- SMS mock: 4-5 hours
- Shared utilities: 1 hour
- Tests and documentation: 2 hours

## Definition of Done

**WhatsApp Mock**:
- [ ] Server runs on port 3003
- [ ] All message endpoints functional
- [ ] Webhook callbacks working
- [ ] Dashboard shows message history
- [ ] Health check passes
- [ ] Integrated into `docker-compose.mocks.yml`

**SMS Mock**:
- [ ] Server runs on port 3004
- [ ] SMS sending endpoint functional
- [ ] Argentina phone validation works
- [ ] Dashboard shows SMS history
- [ ] Health check passes
- [ ] Integrated into `docker-compose.mocks.yml`

**Both**:
- [ ] Swagger docs available
- [ ] Unit tests pass (>60% coverage)
- [ ] README with API documentation
- [ ] Tested with main BarberPro app

## Notes

**WhatsApp Business API Compatibility**:
- Simplified version of official API
- Focus on text and template messages
- Media support is basic (just stores URL)

**SMS Gateway Compatibility**:
- Twilio-style API structure
- Only Argentina phone numbers (+54)
- Mock cost calculation

**Shared Utilities**:
Consider creating `docker/mocks/shared/` for:
- Logger configuration
- Health check helper
- Webhook delivery helper
- ID generation

**Environment Variables**:
```
# WhatsApp Mock
WHATSAPP_MOCK_PORT=3003
WHATSAPP_MOCK_WEBHOOK_URL=http://backend:3000/api/webhooks/whatsapp

# SMS Mock
SMS_MOCK_PORT=3004
SMS_MOCK_WEBHOOK_URL=http://backend:3000/api/webhooks/sms
SMS_MOCK_COST_PER_SEGMENT=0.05
```
