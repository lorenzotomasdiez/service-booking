---
name: Integrate MailHog and Create docker-compose.mocks.yml
status: completed
created: 2025-10-10T11:16:30Z
updated: 2025-10-12T03:47:00Z
completed: 2025-10-12T03:47:00Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/7
depends_on: [4, 5, 6]
parallel: false
conflicts_with: []
---

# Task: Integrate MailHog and Create docker-compose.mocks.yml

## Description

Integrate MailHog (existing email testing solution) and consolidate all Argentina mock servers (MercadoPago, AFIP, WhatsApp, SMS, Email) into a single `docker-compose.mocks.yml` file. Configure networking, health checks, and environment variables to enable seamless integration with the main BarberPro application.

**Goal**: Single command (`make mocks`) to start all Argentina service mocks.

## Acceptance Criteria

- [ ] MailHog integrated into docker-compose.mocks.yml
  - SMTP server on port 1025
  - Web UI on port 8025
  - Health check configured
- [ ] All mock servers in docker-compose.mocks.yml:
  - MercadoPago mock (port 3001)
  - AFIP mock (port 3002)
  - WhatsApp mock (port 3003)
  - SMS mock (port 3004)
  - MailHog (ports 1025, 8025)
- [ ] All mocks on shared network: `barberpro-dev-network`
- [ ] Health checks configured for all services
- [ ] Service dependencies properly ordered
- [ ] Environment variables configured via `.env`
- [ ] Volume mounts for persistent data where needed
- [ ] Resource limits set for all services
- [ ] Consistent container naming: `barberpro-<service>-mock`
- [ ] All services start successfully with `docker-compose -f docker/docker-compose.mocks.yml up`
- [ ] Makefile command `make mocks` starts all mocks
- [ ] Makefile command `make mocks-down` stops all mocks
- [ ] Documentation in `docker/mocks/README.md`

## Technical Details

**docker-compose.mocks.yml Structure**:
```yaml
version: '3.8'

networks:
  barberpro-dev-network:
    external: true  # Use existing network from base compose

services:
  # MercadoPago Mock
  mercadopago-mock:
    build:
      context: ./mocks/mercadopago
      dockerfile: Dockerfile
    container_name: barberpro-mercadopago-mock
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      WEBHOOK_URL: ${MERCADOPAGO_WEBHOOK_URL:-http://backend:3000/api/webhooks/mercadopago}
      DEFAULT_SCENARIO: ${MERCADOPAGO_DEFAULT_SCENARIO:-success}
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # AFIP Mock
  afip-mock:
    build:
      context: ./mocks/afip
      dockerfile: Dockerfile
    container_name: barberpro-afip-mock
    ports:
      - "3002:3002"
    environment:
      PORT: 3002
      DB_PATH: /app/data/afip.db
    volumes:
      - afip-data:/app/data
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # WhatsApp Mock
  whatsapp-mock:
    build:
      context: ./mocks/whatsapp
      dockerfile: Dockerfile
    container_name: barberpro-whatsapp-mock
    ports:
      - "3003:3003"
    environment:
      PORT: 3003
      WEBHOOK_URL: ${WHATSAPP_WEBHOOK_URL:-http://backend:3000/api/webhooks/whatsapp}
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # SMS Mock
  sms-mock:
    build:
      context: ./mocks/sms
      dockerfile: Dockerfile
    container_name: barberpro-sms-mock
    ports:
      - "3004:3004"
    environment:
      PORT: 3004
      WEBHOOK_URL: ${SMS_WEBHOOK_URL:-http://backend:3000/api/webhooks/sms}
      COST_PER_SEGMENT: ${SMS_COST_PER_SEGMENT:-0.05}
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # MailHog (Email Mock)
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: barberpro-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

volumes:
  afip-data:
    driver: local
    name: barberpro-afip-data
```

**Makefile Commands** (add to existing Makefile):
```makefile
mocks: check-docker ## Start all Argentina mock services
	@echo "$(CYAN)[→]$(RESET) Starting Argentina mock services..."
	@docker-compose -f docker/docker-compose.mocks.yml up -d
	@echo "$(GREEN)[✓]$(RESET) Mock services started"
	@echo ""
	@echo "Mock services available at:"
	@echo "  MercadoPago: http://localhost:3001/dashboard"
	@echo "  AFIP:        http://localhost:3002/docs"
	@echo "  WhatsApp:    http://localhost:3003/dashboard"
	@echo "  SMS:         http://localhost:3004/dashboard"
	@echo "  Email:       http://localhost:8025"

mocks-down: ## Stop all mock services
	@echo "$(CYAN)[→]$(RESET) Stopping mock services..."
	@docker-compose -f docker/docker-compose.mocks.yml down
	@echo "$(GREEN)[✓]$(RESET) Mock services stopped"

mocks-logs: ## View logs from all mock services
	@docker-compose -f docker/docker-compose.mocks.yml logs -f

mocks-reset: ## Reset mock services (stop, remove volumes, start)
	@echo "$(CYAN)[→]$(RESET) Resetting mock services..."
	@docker-compose -f docker/docker-compose.mocks.yml down -v
	@docker-compose -f docker/docker-compose.mocks.yml up -d
	@echo "$(GREEN)[✓]$(RESET) Mock services reset"
```

**Environment Variables** (add to `.env.example`):
```bash
# === Argentina Mock Services ===

# MercadoPago Mock
MERCADOPAGO_MOCK_URL=http://localhost:3001
MERCADOPAGO_WEBHOOK_URL=http://backend:3000/api/webhooks/mercadopago
MERCADOPAGO_DEFAULT_SCENARIO=success

# AFIP Mock
AFIP_MOCK_URL=http://localhost:3002

# WhatsApp Mock
WHATSAPP_MOCK_URL=http://localhost:3003
WHATSAPP_WEBHOOK_URL=http://backend:3000/api/webhooks/whatsapp

# SMS Mock
SMS_MOCK_URL=http://localhost:3004
SMS_WEBHOOK_URL=http://backend:3000/api/webhooks/sms
SMS_COST_PER_SEGMENT=0.05

# Email Mock (MailHog)
SMTP_HOST=localhost
SMTP_PORT=1025
MAILHOG_UI=http://localhost:8025
```

**Documentation** (`docker/mocks/README.md`):
```markdown
# Argentina Service Mocks

Local mock servers for Argentina-specific external services.

## Services

- **MercadoPago**: Payment gateway mock (port 3001)
- **AFIP**: Tax authority mock (port 3002)
- **WhatsApp**: Business messaging mock (port 3003)
- **SMS**: SMS gateway mock (port 3004)
- **MailHog**: Email capture (ports 1025, 8025)

## Quick Start

```bash
# Start all mocks
make mocks

# Stop all mocks
make mocks-down

# View logs
make mocks-logs

# Reset (clear data and restart)
make mocks-reset
```

## Web Interfaces

- MercadoPago Dashboard: http://localhost:3001/dashboard
- AFIP API Docs: http://localhost:3002/docs
- WhatsApp Dashboard: http://localhost:3003/dashboard
- SMS Dashboard: http://localhost:3004/dashboard
- Email UI: http://localhost:8025

## Configuration

Configure via `.env` file or environment variables.
See `.env.example` for available options.
```

## Dependencies

- [ ] Task 2 completed (docker-compose structure)
- [ ] Task 4 completed (MercadoPago mock)
- [ ] Task 5 completed (AFIP mock)
- [ ] Task 6 completed (WhatsApp & SMS mocks)
- [ ] MailHog Docker image available

## Effort Estimate

- **Size**: S
- **Hours**: 4-6 hours
- **Parallel**: false (depends on mock servers being built)

**Breakdown**:
- docker-compose.mocks.yml creation: 2 hours
- Makefile commands: 1 hour
- Environment configuration: 1 hour
- Testing and documentation: 1-2 hours

## Definition of Done

- [ ] docker-compose.mocks.yml created with all 5 services
- [ ] All mocks start successfully
- [ ] Health checks pass for all services
- [ ] `make mocks` command works
- [ ] `make mocks-down` command works
- [ ] All services accessible at documented URLs
- [ ] Network connectivity between mocks and main app verified
- [ ] Environment variables documented in `.env.example`
- [ ] README.md created in `docker/mocks/`
- [ ] Tested with main BarberPro app (payment flow, tax reporting, notifications)

## Notes

**Testing Integration**:
```bash
# Test MercadoPago flow
curl -X POST http://localhost:3001/v1/payments \
  -H "Content-Type: application/json" \
  -d '{"transaction_amount": 100, "payer": {...}}'

# View captured emails
open http://localhost:8025

# Check WhatsApp messages
open http://localhost:3003/dashboard
```

**Resource Usage**:
- All 5 mocks combined: ~1GB memory, minimal CPU
- Lightweight enough to run alongside dev environment
- Can stop mocks when not needed: `make mocks-down`
