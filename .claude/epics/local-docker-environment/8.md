---
name: Setup Monitoring Stack (Prometheus, Grafana, Loki, cAdvisor)
status: completed
created: 2025-10-10T11:16:30Z
updated: 2025-10-12T04:30:00Z
completed: 2025-10-12T04:30:00Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/8
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Setup Monitoring Stack (Prometheus, Grafana, Loki, cAdvisor)

## Description

Create an optional monitoring stack in `docker-compose.monitoring.yml` with Prometheus (metrics), Grafana (visualization), Loki (log aggregation), and cAdvisor (container metrics). Include pre-built Grafana dashboards for BarberPro and configuration for scraping metrics from backend, postgres, and redis services.

**Goal**: Enable local performance debugging and load testing with production-like observability.

**Priority**: P1 (Should Have - Optional feature)

## Acceptance Criteria

- [x] docker-compose.monitoring.yml created with 4 services:
  - Prometheus (port 9090)
  - Grafana (port 3001)
  - Loki (port 3100)
  - cAdvisor (port 8080)
- [x] Prometheus configuration:
  - Scrapes backend `/metrics` endpoint
  - PostgreSQL exporter configured
  - Redis exporter configured
  - Scrape interval: 15s
- [x] Grafana configuration:
  - Pre-provisioned datasources (Prometheus, Loki)
  - Pre-built dashboards:
    - BarberPro API Metrics
    - PostgreSQL Performance
    - Redis Performance
    - Container Resource Usage
  - Admin credentials configurable via env vars
- [x] Loki configuration:
  - Collects logs from all Docker services
  - Configured for local development (file-based storage)
  - Log retention: 7 days
- [x] cAdvisor:
  - Monitors all containers
  - Exports metrics to Prometheus
- [x] Makefile commands:
  - `make monitoring` - Start monitoring stack
  - `make monitoring-down` - Stop monitoring stack
  - `make monitoring-logs` - View monitoring logs
  - `make grafana` - Open Grafana in browser
- [x] All services on shared network
- [x] Health checks configured
- [x] Documentation in `docker/monitoring/README.md`

## Technical Details

**Directory Structure**:
```
docker/monitoring/
├── prometheus/
│   ├── prometheus.yml       # Prometheus config
│   └── alerts.yml          # Alert rules
├── grafana/
│   ├── provisioning/
│   │   ├── datasources/
│   │   │   └── datasources.yml
│   │   └── dashboards/
│   │       ├── dashboards.yml
│   │       └── barberpro-api.json
│   │       └── postgres.json
│   │       └── redis.json
│   │       └── containers.json
│   └── grafana.ini         # Grafana config
├── loki/
│   └── loki-config.yml
└── README.md
```

**docker-compose.monitoring.yml**:
```yaml
version: '3.8'

networks:
  barberpro-dev-network:
    external: true

services:
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: barberpro-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  grafana:
    image: grafana/grafana:10.2.2
    container_name: barberpro-grafana
    ports:
      - "3001:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/grafana.ini:/etc/grafana/grafana.ini
      - grafana-data:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    networks:
      - barberpro-dev-network
    depends_on:
      - prometheus
      - loki
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.3
    container_name: barberpro-loki
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki/loki-config.yml:/etc/loki/loki-config.yml
      - loki-data:/loki
    command: -config.file=/etc/loki/loki-config.yml
    networks:
      - barberpro-dev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: barberpro-cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    networks:
      - barberpro-dev-network
    restart: unless-stopped

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
```

**Prometheus Configuration** (`prometheus.yml`):
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'barberpro-backend'
    static_configs:
      - targets: ['backend:3000']
    metrics_path: '/metrics'

  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']

  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

**Grafana Datasources** (`datasources.yml`):
```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    editable: false
```

**Sample Dashboard JSON** (BarberPro API Metrics):
```json
{
  "dashboard": {
    "title": "BarberPro API Metrics",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Response Time (p95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, http_request_duration_seconds_bucket)"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])"
          }
        ]
      }
    ]
  }
}
```

**Makefile Commands**:
```makefile
monitoring: check-docker ## Start monitoring stack
	@echo "$(CYAN)[→]$(RESET) Starting monitoring stack..."
	@docker-compose -f docker/docker-compose.monitoring.yml up -d
	@echo "$(GREEN)[✓]$(RESET) Monitoring stack started"
	@echo ""
	@echo "Monitoring services:"
	@echo "  Prometheus: http://localhost:9090"
	@echo "  Grafana:    http://localhost:3001 (admin/admin)"
	@echo "  Loki:       http://localhost:3100"
	@echo "  cAdvisor:   http://localhost:8080"

monitoring-down: ## Stop monitoring stack
	@docker-compose -f docker/docker-compose.monitoring.yml down

grafana: ## Open Grafana in browser
	@$(OPEN) http://localhost:3001
```

## Dependencies

- [x] Task 2 completed (docker structure)
- [x] Backend /metrics endpoint exists (or needs to be added)
- [x] Docker images: prometheus, grafana, loki, cadvisor

## Effort Estimate

- **Size**: M
- **Hours**: 10-12 hours
- **Parallel**: true (optional feature, doesn't block core workflow)

**Breakdown**:
- Docker compose setup: 2-3 hours
- Prometheus configuration: 2 hours
- Grafana dashboards creation: 3-4 hours
- Loki configuration: 1-2 hours
- Testing and documentation: 2 hours

## Definition of Done

- [x] docker-compose.monitoring.yml created
- [x] All 4 services start successfully
- [x] Prometheus scraping metrics from backend
- [x] Grafana accessible with pre-built dashboards
- [x] Loki aggregating logs from all services
- [x] cAdvisor showing container metrics
- [x] Makefile commands working
- [x] Documentation in `docker/monitoring/README.md`
- [x] Tested load scenario with Artillery
- [x] Grafana dashboards show real data

## Notes

**Backend /metrics Endpoint**:
If not exists, add using prom-client:
```javascript
const promClient = require('prom-client');
const register = new promClient.Registry();

// Collect default metrics
promClient.collectDefaultMetrics({ register });

// Custom metrics
const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code']
});
register.registerMetric(httpRequestDuration);

// Expose metrics endpoint
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

**Resource Usage Note**:
Monitoring stack is resource-intensive (~1.5GB memory). Only start when needed for performance debugging or load testing.

**Environment Variables**:
```
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin
PROMETHEUS_RETENTION_DAYS=7
LOKI_RETENTION_DAYS=7
```
