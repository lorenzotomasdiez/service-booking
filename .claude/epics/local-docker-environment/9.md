---
name: Integration Testing & Environment Variable Configuration
status: open
created: 2025-10-10T11:16:30Z
updated: 2025-10-10T13:33:50Z
github: https://github.com/lorenzotomasdiez/service-booking/issues/9
depends_on: [2, 3, 7]
parallel: false
conflicts_with: []
---

# Task: Integration Testing & Environment Variable Configuration

## Description

Configure environment variables to connect the BarberPro main application to all mock services, and perform comprehensive integration testing to ensure the entire Docker environment works end-to-end. This includes testing payment flows, tax reporting, notifications, and database operations.

**Goal**: Verify the complete local development environment works seamlessly with zero external dependencies.

## Acceptance Criteria

**Environment Configuration**:
- [ ] Created `.env.development` for local Docker environment
- [ ] Backend configured to use mock services in development:
  - MercadoPago mock URL
  - AFIP mock URL
  - WhatsApp mock URL
  - SMS mock URL
  - MailHog SMTP settings
- [ ] Frontend configured to connect to Dockerized backend
- [ ] Database connection strings updated for Docker network
- [ ] Redis connection configured for Docker network
- [ ] CORS settings allow Docker container IPs
- [ ] Environment variable precedence documented

**Integration Tests**:
- [ ] Payment flow test (create booking â†’ pay via MercadoPago mock â†’ verify)
- [ ] Tax reporting test (create invoice â†’ AFIP mock validation â†’ CAE generated)
- [ ] WhatsApp notification test (booking confirmation â†’ WhatsApp mock â†’ verify sent)
- [ ] SMS notification test (booking reminder â†’ SMS mock â†’ verify sent)
- [ ] Email test (booking confirmation â†’ MailHog â†’ verify captured)
- [ ] Database migration test (fresh DB â†’ run migrations â†’ verify schema)
- [ ] Database seed test (run seed â†’ verify data â†’ query works)
- [ ] Full stack test (frontend â†’ backend â†’ database â†’ mocks â†’ response)

**Documentation**:
- [ ] Environment setup guide updated
- [ ] Troubleshooting guide for common integration issues
- [ ] Environment variable reference document

## Technical Details

**Environment Variable Structure**:

`.env.development`:
```bash
# === Application ===
NODE_ENV=development
FRONTEND_URL=http://localhost:5173
BACKEND_URL=http://localhost:3000

# === Database ===
DATABASE_URL=postgresql://barberpro:barberpro_dev_password@postgres:5432/barberpro_dev
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=barberpro_dev
POSTGRES_USER=barberpro
POSTGRES_PASSWORD=barberpro_dev_password

# === Redis ===
REDIS_URL=redis://redis:6379
REDIS_HOST=redis
REDIS_PORT=6379

# === Argentina Mock Services ===
# MercadoPago
MERCADOPAGO_BASE_URL=http://mercadopago-mock:3001
MERCADOPAGO_ACCESS_TOKEN=test_mock_token
MERCADOPAGO_PUBLIC_KEY=test_mock_public_key
MERCADOPAGO_WEBHOOK_URL=http://backend:3000/api/webhooks/mercadopago

# AFIP
AFIP_BASE_URL=http://afip-mock:3002
AFIP_CUIT=20123456789
AFIP_CERT_PATH=/app/certs/afip-mock.crt
AFIP_KEY_PATH=/app/certs/afip-mock.key

# WhatsApp
WHATSAPP_API_URL=http://whatsapp-mock:3003
WHATSAPP_API_TOKEN=test_mock_token
WHATSAPP_WEBHOOK_URL=http://backend:3000/api/webhooks/whatsapp

# SMS
SMS_API_URL=http://sms-mock:3004
SMS_API_KEY=test_mock_key
SMS_WEBHOOK_URL=http://backend:3000/api/webhooks/sms

# Email (MailHog)
SMTP_HOST=mailhog
SMTP_PORT=1025
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM=noreply@barberpro.local

# === CORS ===
CORS_ORIGIN=http://localhost:5173,http://frontend:5173
```

**Backend Configuration Update** (example for MercadoPago):
```typescript
// backend/src/config/mercadopago.config.ts
export const mercadopagoConfig = {
  baseUrl: process.env.MERCADOPAGO_BASE_URL || 'https://api.mercadopago.com',
  accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN,
  publicKey: process.env.MERCADOPAGO_PUBLIC_KEY,
  webhookUrl: process.env.MERCADOPAGO_WEBHOOK_URL,
  // Use mock in development
  isMock: process.env.NODE_ENV === 'development'
};
```

**Frontend Configuration Update**:
```typescript
// frontend/src/lib/config.ts
export const config = {
  apiUrl: import.meta.env.VITE_BACKEND_URL || 'http://localhost:3000',
  mercadopagoPublicKey: import.meta.env.VITE_MERCADOPAGO_PUBLIC_KEY,
  environment: import.meta.env.MODE
};
```

**Integration Test Script** (`scripts/test-integration.sh`):
```bash
#!/bin/bash

echo "ðŸ§ª Running Integration Tests..."

# 1. Test database connectivity
echo "Testing database..."
docker-compose exec backend npm run db:test || exit 1

# 2. Test payment flow
echo "Testing payment flow..."
curl -X POST http://localhost:3000/api/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "service_id": "test-service",
    "date": "2025-10-15T10:00:00Z",
    "customer_id": "test-customer"
  }' || exit 1

# 3. Test AFIP mock
echo "Testing AFIP..."
curl -X POST http://localhost:3002/wsfev1/FECAESolicitar \
  -H "Content-Type: application/json" \
  -d '{"invoice_data": {...}}' || exit 1

# 4. Test WhatsApp mock
echo "Testing WhatsApp..."
curl -X POST http://localhost:3003/v1/messages \
  -H "Content-Type: application/json" \
  -d '{"to": "+54 9 11 1234-5678", "body": "Test"}' || exit 1

# 5. Test MailHog
echo "Testing email..."
curl http://localhost:8025/api/v2/messages || exit 1

echo "âœ… All integration tests passed!"
```

**docker-compose.test.yml**:
```yaml
version: '3.8'

# Extend base and dev compose files
# Add test-specific configuration

services:
  backend:
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://barberpro:test_password@postgres:5432/barberpro_test
    command: npm run test:integration

  frontend:
    environment:
      NODE_ENV: test
    command: npm run test:e2e
```

**CORS Configuration Update** (`backend/src/middleware/cors.ts`):
```typescript
const corsOptions = {
  origin: (origin, callback) => {
    const allowedOrigins = [
      'http://localhost:5173',
      'http://frontend:5173',
      'http://localhost:3000',
      // Docker container IPs (if needed)
      /^http:\/\/172\.[\d]+\.[\d]+\.[\d]+:5173$/
    ];

    if (!origin || allowedOrigins.some(allowed =>
      typeof allowed === 'string' ? allowed === origin : allowed.test(origin)
    )) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
};
```

## Dependencies

- [ ] Task 2 completed (docker-compose files ready)
- [ ] Task 3 completed (Makefile ready)
- [ ] Task 7 completed (all mocks available)
- [ ] Backend services can accept environment variable configuration
- [ ] Frontend can connect to backend via Docker network

## Effort Estimate

- **Size**: M
- **Hours**: 8-10 hours
- **Parallel**: false (needs mocks and base infrastructure)

**Breakdown**:
- Environment variable configuration: 2-3 hours
- Backend configuration updates: 2 hours
- Frontend configuration updates: 1 hour
- Integration test scripts: 2-3 hours
- Testing and validation: 2 hours

## Definition of Done

- [ ] All environment variables documented in `.env.example`
- [ ] `.env.development` created with Docker-specific configuration
- [ ] Backend connects to all mock services successfully
- [ ] Frontend connects to Dockerized backend
- [ ] Payment flow test passes end-to-end
- [ ] AFIP integration test passes
- [ ] All notification channels (WhatsApp, SMS, Email) working
- [ ] Database migrations and seeds work in Docker
- [ ] Integration test script passes all checks
- [ ] CORS configured correctly for Docker network
- [ ] Documentation updated with environment setup
- [ ] Troubleshooting guide created

## Notes

**Environment Precedence**:
1. Command-line environment variables (highest)
2. `.env.local` (gitignored, developer-specific)
3. `.env.development` (Docker default)
4. `.env.example` (template, not loaded)
5. Default values in code (lowest)

**Common Integration Issues**:

1. **CORS Errors**:
   - Solution: Add container IPs to allowed origins
   - Check: `docker inspect <container> | grep IPAddress`

2. **Connection Refused**:
   - Solution: Use service names, not localhost
   - Example: `postgres:5432` not `localhost:5432`

3. **Webhook Delivery**:
   - Solution: Use internal Docker network URLs
   - Example: `http://backend:3000/webhooks` not `http://localhost:3000/webhooks`

4. **Database Connection**:
   - Ensure postgres is healthy before backend starts
   - Use `depends_on` with health checks

**Testing Checklist**:
```bash
# Quick validation
make up                  # Start everything
make status              # Check health
make logs-backend        # Check backend logs
make logs-frontend       # Check frontend logs
curl http://localhost:3000/health  # Backend health
curl http://localhost:5173         # Frontend access
```
