<!-- MicroInteractions.svelte - Enhanced micro-interactions for Argentina mobile users -->
<script lang="ts">
  import { onMount, createEventDispatcher } from 'svelte';
  import { browser } from '$app/environment';
  import { shouldReduceAnimations } from '$lib/services/ux-optimization';
  
  interface InteractionConfig {
    type: 'button' | 'card' | 'input' | 'toggle' | 'loading' | 'success' | 'error';
    variant?: 'subtle' | 'normal' | 'prominent';
    hapticFeedback?: boolean;
    soundFeedback?: boolean;
    argentina?: boolean; // WhatsApp-style interactions familiar to Argentina users
  }
  
  // Props
  export let config: InteractionConfig;
  export let disabled = false;
  export let loading = false;
  export let active = false;
  export let success = false;
  export let error = false;
  
  let className = '';
  export { className as class };
  
  const dispatch = createEventDispatcher<{
    interact: { type: string; timestamp: number };
    complete: { type: string; duration: number };
  }>();
  
  // State
  let element: HTMLElement;
  let isPressed = false;
  let isHovered = false;
  let interactionStartTime = 0;
  
  // Haptic feedback (for mobile devices)
  function triggerHapticFeedback(intensity: 'light' | 'medium' | 'heavy' = 'light') {\n    if (!browser || !config.hapticFeedback) return;\n    \n    // Use Vibration API for Android (common in Argentina)\n    if ('vibrator' in navigator || 'vibrate' in navigator) {\n      const patterns = {\n        light: [10],\n        medium: [20],\n        heavy: [50]\n      };\n      \n      (navigator as any).vibrate?.(patterns[intensity]);\n    }\n    \n    // For iOS devices (less common in Argentina but still supported)\n    if ('haptic' in navigator) {\n      (navigator as any).haptic.impact(intensity);\n    }\n  }\n  \n  // Sound feedback (subtle audio cues)\n  function triggerSoundFeedback(type: 'tap' | 'success' | 'error' | 'toggle') {\n    if (!browser || !config.soundFeedback) return;\n    \n    // Create subtle audio feedback using Web Audio API\n    try {\n      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      const oscillator = audioContext.createOscillator();\n      const gainNode = audioContext.createGain();\n      \n      oscillator.connect(gainNode);\n      gainNode.connect(audioContext.destination);\n      \n      // Different frequencies for different interaction types\n      const frequencies = {\n        tap: 800,\n        success: 1000,\n        error: 400,\n        toggle: 600\n      };\n      \n      oscillator.frequency.setValueAtTime(frequencies[type], audioContext.currentTime);\n      oscillator.type = 'sine';\n      \n      // Very short, subtle sound\n      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);\n      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);\n      \n      oscillator.start();\n      oscillator.stop(audioContext.currentTime + 0.1);\n    } catch (error) {\n      // Silently fail if Web Audio API is not supported\n      console.debug('[MicroInteractions] Audio feedback not available');\n    }\n  }\n  \n  // Handle pointer down (mouse/touch start)\n  function handlePointerDown(event: PointerEvent) {\n    if (disabled) return;\n    \n    isPressed = true;\n    interactionStartTime = Date.now();\n    \n    // Trigger haptic feedback for press\n    triggerHapticFeedback('light');\n    \n    // Trigger sound feedback\n    if (config.type === 'toggle') {\n      triggerSoundFeedback('toggle');\n    } else {\n      triggerSoundFeedback('tap');\n    }\n    \n    dispatch('interact', { type: 'press', timestamp: interactionStartTime });\n    \n    // Add pressed class for immediate visual feedback\n    if (element) {\n      element.classList.add('micro-pressed');\n    }\n  }\n  \n  // Handle pointer up (mouse/touch end)\n  function handlePointerUp(event: PointerEvent) {\n    if (disabled) return;\n    \n    isPressed = false;\n    const duration = Date.now() - interactionStartTime;\n    \n    // Remove pressed class\n    if (element) {\n      element.classList.remove('micro-pressed');\n      \n      // Add completion animation based on type\n      if (config.type === 'button' && !$shouldReduceAnimations) {\n        element.classList.add('micro-complete');\n        setTimeout(() => {\n          element.classList.remove('micro-complete');\n        }, 300);\n      }\n    }\n    \n    dispatch('complete', { type: 'press', duration });\n  }\n  \n  // Handle hover (desktop)\n  function handleMouseEnter() {\n    if (disabled || !browser) return;\n    \n    isHovered = true;\n    \n    // Subtle hover feedback\n    if (config.variant === 'prominent') {\n      triggerHapticFeedback('light');\n    }\n  }\n  \n  function handleMouseLeave() {\n    isHovered = false;\n  }\n  \n  // Handle focus (keyboard navigation)\n  function handleFocus() {\n    if (disabled) return;\n    \n    dispatch('interact', { type: 'focus', timestamp: Date.now() });\n  }\n  \n  // Handle successful actions\n  function handleSuccess() {\n    triggerHapticFeedback('medium');\n    triggerSoundFeedback('success');\n    \n    if (element && !$shouldReduceAnimations) {\n      element.classList.add('micro-success');\n      setTimeout(() => {\n        element.classList.remove('micro-success');\n      }, 500);\n    }\n  }\n  \n  // Handle error actions\n  function handleError() {\n    triggerHapticFeedback('heavy');\n    triggerSoundFeedback('error');\n    \n    if (element && !$shouldReduceAnimations) {\n      element.classList.add('micro-error');\n      setTimeout(() => {\n        element.classList.remove('micro-error');\n      }, 400);\n    }\n  }\n  \n  // Reactive handlers\n  $: if (success && browser) handleSuccess();\n  $: if (error && browser) handleError();\n  \n  onMount(() => {\n    if (!element) return;\n    \n    // Set up pointer events for better mobile support\n    element.addEventListener('pointerdown', handlePointerDown, { passive: true });\n    element.addEventListener('pointerup', handlePointerUp, { passive: true });\n    element.addEventListener('mouseenter', handleMouseEnter, { passive: true });\n    element.addEventListener('mouseleave', handleMouseLeave, { passive: true });\n    element.addEventListener('focus', handleFocus, { passive: true });\n    \n    // Prevent context menu on long press for mobile\n    element.addEventListener('contextmenu', (e) => {\n      if (config.type === 'button' && window.innerWidth <= 640) {\n        e.preventDefault();\n      }\n    });\n    \n    return () => {\n      element.removeEventListener('pointerdown', handlePointerDown);\n      element.removeEventListener('pointerup', handlePointerUp);\n      element.removeEventListener('mouseenter', handleMouseEnter);\n      element.removeEventListener('mouseleave', handleMouseLeave);\n      element.removeEventListener('focus', handleFocus);\n    };\n  });\n</script>\n\n<div \n  bind:this={element}\n  class=\"micro-interaction {config.type} {config.variant || 'normal'} {className}\"\n  class:argentina-style={config.argentina}\n  class:disabled\n  class:loading\n  class:active\n  class:pressed={isPressed}\n  class:hovered={isHovered}\n  class:reduced-motion={$shouldReduceAnimations}\n  role={config.type === 'button' ? 'button' : undefined}\n  tabindex={config.type === 'button' && !disabled ? '0' : undefined}\n>\n  <slot />\n  \n  <!-- Loading indicator -->\n  {#if loading && !$shouldReduceAnimations}\n    <div class=\"micro-loading\">\n      <div class=\"loading-spinner\"></div>\n    </div>\n  {/if}\n  \n  <!-- Success indicator -->\n  {#if success && !$shouldReduceAnimations}\n    <div class=\"micro-success-indicator\">\n      <svg class=\"success-checkmark\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"3\" d=\"M5 13l4 4L19 7\" />\n      </svg>\n    </div>\n  {/if}\n  \n  <!-- Error indicator -->\n  {#if error && !$shouldReduceAnimations}\n    <div class=\"micro-error-indicator\">\n      <svg class=\"error-x\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"3\" d=\"M6 18L18 6M6 6l12 12\" />\n      </svg>\n    </div>\n  {/if}\n  \n  <!-- Ripple effect for Argentina-style interactions -->\n  {#if config.argentina && !$shouldReduceAnimations}\n    <div class=\"ripple-container\">\n      <!-- Ripple effects will be dynamically added here -->\n    </div>\n  {/if}\n</div>\n\n<style>\n  .micro-interaction {\n    position: relative;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    user-select: none;\n    -webkit-tap-highlight-color: transparent;\n    outline: none;\n  }\n  \n  /* Button interactions */\n  .micro-interaction.button {\n    cursor: pointer;\n    border-radius: 8px;\n  }\n  \n  .micro-interaction.button:hover:not(.disabled) {\n    transform: translateY(-1px);\n  }\n  \n  .micro-interaction.button.pressed:not(.disabled) {\n    transform: translateY(0) scale(0.98);\n  }\n  \n  /* Card interactions */\n  .micro-interaction.card {\n    cursor: pointer;\n    border-radius: 12px;\n  }\n  \n  .micro-interaction.card:hover:not(.disabled) {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);\n  }\n  \n  .micro-interaction.card.pressed:not(.disabled) {\n    transform: translateY(0) scale(0.99);\n  }\n  \n  /* Input interactions */\n  .micro-interaction.input {\n    border-radius: 6px;\n  }\n  \n  .micro-interaction.input:focus-within {\n    transform: scale(1.02);\n    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\n  }\n  \n  /* Toggle interactions */\n  .micro-interaction.toggle {\n    cursor: pointer;\n    border-radius: 20px;\n  }\n  \n  .micro-interaction.toggle.active {\n    background: #2563eb;\n    color: white;\n  }\n  \n  /* Loading state */\n  .micro-interaction.loading {\n    pointer-events: none;\n    opacity: 0.7;\n  }\n  \n  /* Disabled state */\n  .micro-interaction.disabled {\n    pointer-events: none;\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n  \n  /* Variants */\n  .micro-interaction.subtle {\n    transition: all 0.15s ease;\n  }\n  \n  .micro-interaction.subtle:hover {\n    transform: translateY(-0.5px);\n  }\n  \n  .micro-interaction.prominent {\n    transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);\n  }\n  \n  .micro-interaction.prominent:hover:not(.disabled) {\n    transform: translateY(-3px) scale(1.05);\n    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);\n  }\n  \n  /* Argentina-style (WhatsApp-inspired) */\n  .micro-interaction.argentina-style {\n    border-radius: 18px;\n    background: #25d366;\n    color: white;\n    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);\n  }\n  \n  .micro-interaction.argentina-style:hover:not(.disabled) {\n    background: #1ea952;\n    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);\n  }\n  \n  .micro-interaction.argentina-style.pressed {\n    background: #1ea952;\n    transform: scale(0.96);\n  }\n  \n  /* Loading spinner */\n  .micro-loading {\n    position: absolute;\n    inset: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: rgba(255, 255, 255, 0.9);\n    border-radius: inherit;\n  }\n  \n  .loading-spinner {\n    width: 1rem;\n    height: 1rem;\n    border: 2px solid #e5e7eb;\n    border-top: 2px solid #2563eb;\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n  }\n  \n  /* Success and error indicators */\n  .micro-success-indicator,\n  .micro-error-indicator {\n    position: absolute;\n    inset: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: inherit;\n  }\n  \n  .micro-success-indicator {\n    background: rgba(34, 197, 94, 0.9);\n    color: white;\n    animation: success-pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n  }\n  \n  .micro-error-indicator {\n    background: rgba(239, 68, 68, 0.9);\n    color: white;\n    animation: error-shake 0.4s ease-in-out;\n  }\n  \n  .success-checkmark,\n  .error-x {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n  \n  /* Completion animations */\n  .micro-interaction.micro-complete {\n    animation: complete-pulse 0.3s ease-out;\n  }\n  \n  .micro-interaction.micro-success {\n    animation: success-glow 0.5s ease-out;\n  }\n  \n  .micro-interaction.micro-error {\n    animation: error-shake 0.4s ease-in-out;\n  }\n  \n  /* Ripple effect for Argentina-style */\n  .ripple-container {\n    position: absolute;\n    inset: 0;\n    border-radius: inherit;\n    overflow: hidden;\n    pointer-events: none;\n  }\n  \n  .ripple {\n    position: absolute;\n    border-radius: 50%;\n    background: rgba(255, 255, 255, 0.3);\n    transform: scale(0);\n    animation: ripple-effect 0.6s ease-out;\n  }\n  \n  /* Mobile optimizations for Argentina */\n  @media (max-width: 640px) {\n    .micro-interaction.button,\n    .micro-interaction.toggle {\n      min-height: 44px;\n      min-width: 44px;\n    }\n    \n    .micro-interaction:hover {\n      transform: none; /* Disable hover effects on touch devices */\n    }\n    \n    .micro-interaction.pressed {\n      transform: scale(0.96);\n    }\n  }\n  \n  /* Reduced motion support */\n  .micro-interaction.reduced-motion {\n    transition: none;\n    animation: none;\n  }\n  \n  .micro-interaction.reduced-motion:hover,\n  .micro-interaction.reduced-motion.pressed {\n    transform: none;\n  }\n  \n  .micro-interaction.reduced-motion .loading-spinner {\n    animation: none;\n    border-top-color: #2563eb;\n  }\n  \n  /* High contrast mode */\n  @media (prefers-contrast: high) {\n    .micro-interaction {\n      border: 2px solid currentColor;\n    }\n    \n    .micro-interaction.argentina-style {\n      background: #000;\n      color: #fff;\n      border-color: #000;\n    }\n  }\n  \n  /* Focus styles for accessibility */\n  .micro-interaction:focus-visible {\n    outline: 2px solid #2563eb;\n    outline-offset: 2px;\n  }\n  \n  /* Animations */\n  @keyframes spin {\n    to {\n      transform: rotate(360deg);\n    }\n  }\n  \n  @keyframes complete-pulse {\n    0%, 100% {\n      transform: scale(1);\n    }\n    50% {\n      transform: scale(1.05);\n    }\n  }\n  \n  @keyframes success-pop {\n    0% {\n      opacity: 0;\n      transform: scale(0.8);\n    }\n    50% {\n      transform: scale(1.1);\n    }\n    100% {\n      opacity: 1;\n      transform: scale(1);\n    }\n  }\n  \n  @keyframes success-glow {\n    0%, 100% {\n      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);\n    }\n    50% {\n      box-shadow: 0 0 0 8px rgba(34, 197, 94, 0.3);\n    }\n  }\n  \n  @keyframes error-shake {\n    0%, 100% {\n      transform: translateX(0);\n    }\n    25% {\n      transform: translateX(-5px);\n    }\n    75% {\n      transform: translateX(5px);\n    }\n  }\n  \n  @keyframes ripple-effect {\n    0% {\n      transform: scale(0);\n      opacity: 1;\n    }\n    100% {\n      transform: scale(4);\n      opacity: 0;\n    }\n  }\n  \n  /* Dark mode support */\n  @media (prefers-color-scheme: dark) {\n    .micro-loading {\n      background: rgba(31, 41, 55, 0.9);\n    }\n    \n    .loading-spinner {\n      border-color: #374151;\n      border-top-color: #60a5fa;\n    }\n  }\n</style>"