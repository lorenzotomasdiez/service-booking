<!-- ProgressiveForm.svelte - Enhanced form experience for Argentina mobile users -->
<script lang="ts">
  import { createEventDispatcher, onMount } from 'svelte';
  import { browser } from '$app/environment';
  import { connectionSpeed, shouldUseSkeletons } from '$lib/services/ux-optimization';
  import { uxAnalyticsService } from '$lib/services/ux-analytics';
  
  interface FormField {
    id: string;
    type: 'text' | 'email' | 'tel' | 'number' | 'select' | 'textarea' | 'dni' | 'cuit';
    label: string;
    placeholder?: string;
    required?: boolean;
    validation?: (value: string) => string | null;
    options?: { value: string; label: string }[];
    priority: 'high' | 'medium' | 'low';
    autocomplete?: string;
    inputmode?: string;
  }
  
  interface FormConfig {
    fields: FormField[];
    submitLabel?: string;
    progressiveLoading?: boolean;
    autoSave?: boolean;
    optimisticUpdates?: boolean;
  }
  
  // Props
  export let config: FormConfig;
  export let initialValues: Record<string, string> = {};
  export let isSubmitting = false;
  export let showProgress = true;
  
  const dispatch = createEventDispatcher<{
    submit: { values: Record<string, string>; fieldAnalytics: any };
    change: { field: string; value: string; analytics: any };
    autoSave: { values: Record<string, string> };
    fieldFocus: { field: string; timestamp: number };
    fieldBlur: { field: string; timeSpent: number; value: string };
  }>();
  
  // State
  let formValues: Record<string, string> = { ...initialValues };
  let fieldErrors: Record<string, string> = {};
  let touchedFields: Set<string> = new Set();
  let fieldFocusTimes: Record<string, number> = {};
  let autoSaveTimeout: number | null = null;
  let visibleFields: Set<string> = new Set();
  let fieldAnalytics: Record<string, any> = {};
  
  // Progressive field loading based on priority and connection speed
  $: highPriorityFields = config.fields.filter(f => f.priority === 'high');
  $: mediumPriorityFields = config.fields.filter(f => f.priority === 'medium');
  $: lowPriorityFields = config.fields.filter(f => f.priority === 'low');
  $: shouldUseProgressive = config.progressiveLoading && $connectionSpeed === 'slow';
  
  onMount(() => {
    // Initialize analytics
    uxAnalyticsService.startFormAnalytics(config.fields.map(f => f.id));
    
    if (shouldUseProgressive) {
      // Load high priority fields immediately
      highPriorityFields.forEach(field => visibleFields.add(field.id));
      visibleFields = new Set(visibleFields);
      
      // Load medium priority fields after 1 second
      setTimeout(() => {
        mediumPriorityFields.forEach(field => visibleFields.add(field.id));
        visibleFields = new Set(visibleFields);
      }, 1000);
      
      // Load low priority fields after 2 seconds or on scroll
      setTimeout(() => {
        lowPriorityFields.forEach(field => visibleFields.add(field.id));
        visibleFields = new Set(visibleFields);
      }, 2000);
    } else {
      // Show all fields immediately
      config.fields.forEach(field => visibleFields.add(field.id));
      visibleFields = new Set(visibleFields);
    }
    
    return () => {
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
    };
  });\n  \n  function handleFieldChange(field: FormField, value: string) {\n    formValues[field.id] = value;\n    formValues = { ...formValues };\n    \n    // Track field analytics\n    const analytics = {\n      fieldId: field.id,\n      valueLength: value.length,\n      timestamp: Date.now(),\n      inputMethod: 'typing' // Could be enhanced to detect voice, paste, etc.\n    };\n    \n    fieldAnalytics[field.id] = {\n      ...fieldAnalytics[field.id],\n      ...analytics,\n      changeCount: (fieldAnalytics[field.id]?.changeCount || 0) + 1\n    };\n    \n    // Validate field\n    validateField(field, value);\n    \n    // Auto-save functionality\n    if (config.autoSave) {\n      if (autoSaveTimeout) {\n        clearTimeout(autoSaveTimeout);\n      }\n      autoSaveTimeout = window.setTimeout(() => {\n        dispatch('autoSave', { values: formValues });\n      }, 2000);\n    }\n    \n    dispatch('change', { field: field.id, value, analytics });\n  }\n  \n  function handleFieldFocus(field: FormField) {\n    const timestamp = Date.now();\n    fieldFocusTimes[field.id] = timestamp;\n    \n    dispatch('fieldFocus', { field: field.id, timestamp });\n    \n    // Track focus analytics\n    uxAnalyticsService.trackFieldFocus(field.id);\n  }\n  \n  function handleFieldBlur(field: FormField) {\n    const focusTime = fieldFocusTimes[field.id];\n    const timeSpent = focusTime ? Date.now() - focusTime : 0;\n    \n    touchedFields.add(field.id);\n    touchedFields = new Set(touchedFields);\n    \n    // Validate on blur\n    validateField(field, formValues[field.id] || '');\n    \n    dispatch('fieldBlur', { \n      field: field.id, \n      timeSpent, \n      value: formValues[field.id] || '' \n    });\n    \n    // Track blur analytics\n    uxAnalyticsService.trackFieldBlur(field.id, timeSpent, formValues[field.id]?.length || 0);\n  }\n  \n  function validateField(field: FormField, value: string) {\n    let error = null;\n    \n    // Required validation\n    if (field.required && !value.trim()) {\n      error = `${field.label} es requerido`;\n    }\n    // Custom validation\n    else if (field.validation && value.trim()) {\n      error = field.validation(value);\n    }\n    // Built-in validations for Argentina\n    else if (field.type === 'email' && value.trim()) {\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      if (!emailRegex.test(value)) {\n        error = 'Ingresa un email válido';\n      }\n    }\n    else if (field.type === 'tel' && value.trim()) {\n      // Argentina phone validation\n      const phoneRegex = /^\\+?54?[\\s-]?9?[\\s-]?11[\\s-]?[0-9]{8}$|^[0-9]{10}$/;\n      if (!phoneRegex.test(value.replace(/[\\s-]/g, ''))) {\n        error = 'Ingresa un teléfono válido (ej: 11 1234-5678)';\n      }\n    }\n    else if (field.type === 'dni' && value.trim()) {\n      // Argentina DNI validation\n      const dniRegex = /^[0-9]{7,8}$/;\n      if (!dniRegex.test(value.replace(/[^0-9]/g, ''))) {\n        error = 'Ingresa un DNI válido (7-8 dígitos)';\n      }\n    }\n    else if (field.type === 'cuit' && value.trim()) {\n      // Argentina CUIT validation\n      const cuitRegex = /^[0-9]{2}-[0-9]{8}-[0-9]$/;\n      if (!cuitRegex.test(value)) {\n        error = 'Ingresa un CUIT válido (XX-XXXXXXXX-X)';\n      }\n    }\n    \n    if (error) {\n      fieldErrors[field.id] = error;\n    } else {\n      delete fieldErrors[field.id];\n    }\n    fieldErrors = { ...fieldErrors };\n  }\n  \n  function handleSubmit() {\n    // Validate all fields\n    let hasErrors = false;\n    config.fields.forEach(field => {\n      validateField(field, formValues[field.id] || '');\n      if (fieldErrors[field.id]) {\n        hasErrors = true;\n      }\n    });\n    \n    if (!hasErrors) {\n      // Compile final analytics\n      const finalAnalytics = {\n        formCompletionTime: Date.now() - (fieldAnalytics.startTime || Date.now()),\n        fieldsCompleted: Object.keys(formValues).filter(key => formValues[key]).length,\n        totalFields: config.fields.length,\n        fieldAnalytics: fieldAnalytics,\n        completionRate: (Object.keys(formValues).filter(key => formValues[key]).length / config.fields.length) * 100\n      };\n      \n      dispatch('submit', { values: formValues, fieldAnalytics: finalAnalytics });\n      \n      // Track successful form submission\n      uxAnalyticsService.completeFormAnalytics(finalAnalytics);\n    } else {\n      // Focus first error field\n      const firstErrorField = config.fields.find(field => fieldErrors[field.id]);\n      if (firstErrorField && browser) {\n        const element = document.getElementById(firstErrorField.id);\n        element?.focus();\n      }\n      \n      // Track form errors\n      uxAnalyticsService.trackFormErrors(Object.keys(fieldErrors));\n    }\n  }\n  \n  function getInputMode(field: FormField): string {\n    switch (field.type) {\n      case 'email':\n        return 'email';\n      case 'tel':\n      case 'number':\n      case 'dni':\n      case 'cuit':\n        return 'numeric';\n      default:\n        return field.inputmode || 'text';\n    }\n  }\n  \n  function getAutocomplete(field: FormField): string {\n    if (field.autocomplete) return field.autocomplete;\n    \n    switch (field.type) {\n      case 'email':\n        return 'email';\n      case 'tel':\n        return 'tel';\n      case 'dni':\n        return 'off'; // DNI is sensitive\n      case 'cuit':\n        return 'off'; // CUIT is sensitive\n      default:\n        return 'on';\n    }\n  }\n  \n  function formatValue(field: FormField, value: string): string {\n    switch (field.type) {\n      case 'dni':\n        // Format DNI with dots\n        return value.replace(/[^0-9]/g, '').replace(/(\\d{2})(\\d{3})(\\d{3})/, '$1.$2.$3');\n      case 'cuit':\n        // Format CUIT with dashes\n        return value.replace(/[^0-9]/g, '').replace(/(\\d{2})(\\d{8})(\\d)/, '$1-$2-$3');\n      case 'tel':\n        // Format Argentina phone\n        const digits = value.replace(/[^0-9]/g, '');\n        if (digits.length >= 10) {\n          return digits.replace(/(\\d{2})(\\d{4})(\\d{4})/, '$1 $2-$3');\n        }\n        return value;\n      default:\n        return value;\n    }\n  }\n</script>\n\n<form class=\"progressive-form\" on:submit|preventDefault={handleSubmit}>\n  {#if showProgress}\n    <!-- Progress indicator -->\n    <div class=\"form-progress\" class:mobile-optimized={$connectionSpeed === 'slow'}>\n      <div class=\"progress-bar\">\n        <div \n          class=\"progress-fill\" \n          style=\"width: {(Object.keys(formValues).filter(key => formValues[key]).length / config.fields.length) * 100}%\"\n        ></div>\n      </div>\n      <span class=\"progress-text\">\n        {Object.keys(formValues).filter(key => formValues[key]).length} de {config.fields.length} campos completados\n      </span>\n    </div>\n  {/if}\n\n  <!-- Form fields -->\n  <div class=\"form-fields\">\n    {#each config.fields as field (field.id)}\n      {#if visibleFields.has(field.id)}\n        <div class=\"field-container\" class:has-error={fieldErrors[field.id]}>\n          <label for={field.id} class=\"field-label\">\n            {field.label}\n            {#if field.required}\n              <span class=\"required-indicator\" aria-label=\"requerido\">*</span>\n            {/if}\n          </label>\n          \n          {#if field.type === 'select'}\n            <select\n              id={field.id}\n              bind:value={formValues[field.id]}\n              on:change={(e) => handleFieldChange(field, e.currentTarget.value)}\n              on:focus={() => handleFieldFocus(field)}\n              on:blur={() => handleFieldBlur(field)}\n              class=\"field-input select-input\"\n              class:error={fieldErrors[field.id]}\n              autocomplete={getAutocomplete(field)}\n              required={field.required}\n            >\n              <option value=\"\">{field.placeholder || `Selecciona ${field.label.toLowerCase()}`}</option>\n              {#each field.options || [] as option}\n                <option value={option.value}>{option.label}</option>\n              {/each}\n            </select>\n          {:else if field.type === 'textarea'}\n            <textarea\n              id={field.id}\n              bind:value={formValues[field.id]}\n              on:input={(e) => handleFieldChange(field, e.currentTarget.value)}\n              on:focus={() => handleFieldFocus(field)}\n              on:blur={() => handleFieldBlur(field)}\n              class=\"field-input textarea-input\"\n              class:error={fieldErrors[field.id]}\n              placeholder={field.placeholder}\n              autocomplete={getAutocomplete(field)}\n              required={field.required}\n              rows=\"3\"\n            ></textarea>\n          {:else}\n            <input\n              id={field.id}\n              type={field.type === 'dni' || field.type === 'cuit' ? 'text' : field.type}\n              bind:value={formValues[field.id]}\n              on:input={(e) => {\n                const formatted = formatValue(field, e.currentTarget.value);\n                formValues[field.id] = formatted;\n                handleFieldChange(field, formatted);\n              }}\n              on:focus={() => handleFieldFocus(field)}\n              on:blur={() => handleFieldBlur(field)}\n              class=\"field-input text-input\"\n              class:error={fieldErrors[field.id]}\n              placeholder={field.placeholder}\n              autocomplete={getAutocomplete(field)}\n              inputmode={getInputMode(field)}\n              required={field.required}\n            />\n          {/if}\n          \n          {#if fieldErrors[field.id]}\n            <div class=\"field-error\" role=\"alert\">\n              <svg class=\"error-icon\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n              {fieldErrors[field.id]}\n            </div>\n          {/if}\n        </div>\n      {:else if shouldUseProgressive}\n        <!-- Field placeholder for progressive loading -->\n        <div class=\"field-placeholder\">\n          {#if $shouldUseSkeletons}\n            <div class=\"skeleton skeleton-label\"></div>\n            <div class=\"skeleton skeleton-input\"></div>\n          {:else}\n            <div class=\"loading-field\">Cargando campo...</div>\n          {/if}\n        </div>\n      {/if}\n    {/each}\n  </div>\n\n  <!-- Submit button -->\n  <div class=\"form-actions\">\n    <button\n      type=\"submit\"\n      class=\"submit-button\"\n      class:submitting={isSubmitting}\n      disabled={isSubmitting || Object.keys(fieldErrors).length > 0}\n    >\n      {#if isSubmitting}\n        <div class=\"submit-spinner\"></div>\n        Enviando...\n      {:else}\n        {config.submitLabel || 'Enviar'}\n      {/if}\n    </button>\n  </div>\n</form>\n\n<style>\n  .progressive-form {\n    max-width: 100%;\n    margin: 0 auto;\n  }\n  \n  /* Progress indicator */\n  .form-progress {\n    margin-bottom: 2rem;\n    padding: 1rem;\n    background: #f9fafb;\n    border-radius: 8px;\n    border: 1px solid #e5e7eb;\n  }\n  \n  .progress-bar {\n    width: 100%;\n    height: 8px;\n    background: #e5e7eb;\n    border-radius: 4px;\n    overflow: hidden;\n    margin-bottom: 0.5rem;\n  }\n  \n  .progress-fill {\n    height: 100%;\n    background: linear-gradient(90deg, #2563eb, #3b82f6);\n    border-radius: 4px;\n    transition: width 0.3s ease;\n  }\n  \n  .progress-text {\n    font-size: 0.875rem;\n    color: #6b7280;\n    font-weight: 500;\n  }\n  \n  /* Form fields */\n  .form-fields {\n    display: flex;\n    flex-direction: column;\n    gap: 1.5rem;\n  }\n  \n  .field-container {\n    position: relative;\n  }\n  \n  .field-label {\n    display: block;\n    font-size: 0.875rem;\n    font-weight: 600;\n    color: #374151;\n    margin-bottom: 0.5rem;\n  }\n  \n  .required-indicator {\n    color: #dc2626;\n    margin-left: 0.25rem;\n  }\n  \n  .field-input {\n    width: 100%;\n    padding: 0.75rem 1rem;\n    border: 2px solid #e5e7eb;\n    border-radius: 8px;\n    font-size: 1rem;\n    line-height: 1.5;\n    background: #ffffff;\n    transition: all 0.2s ease;\n    min-height: 44px; /* Argentina mobile optimization */\n  }\n  \n  .field-input:focus {\n    outline: none;\n    border-color: #2563eb;\n    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\n  }\n  \n  .field-input.error {\n    border-color: #dc2626;\n    background: #fef2f2;\n  }\n  \n  .textarea-input {\n    resize: vertical;\n    min-height: 80px;\n  }\n  \n  .select-input {\n    background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e\");\n    background-position: right 0.5rem center;\n    background-repeat: no-repeat;\n    background-size: 1.5em 1.5em;\n    padding-right: 3rem;\n    appearance: none;\n  }\n  \n  /* Field errors */\n  .field-error {\n    display: flex;\n    align-items: center;\n    margin-top: 0.5rem;\n    font-size: 0.875rem;\n    color: #dc2626;\n  }\n  \n  .error-icon {\n    width: 1rem;\n    height: 1rem;\n    margin-right: 0.5rem;\n    flex-shrink: 0;\n  }\n  \n  /* Field placeholder for progressive loading */\n  .field-placeholder {\n    margin-bottom: 1.5rem;\n  }\n  \n  .skeleton {\n    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);\n    background-size: 200% 100%;\n    animation: skeleton-pulse 1.5s infinite;\n    border-radius: 4px;\n  }\n  \n  .skeleton-label {\n    height: 1rem;\n    width: 30%;\n    margin-bottom: 0.5rem;\n  }\n  \n  .skeleton-input {\n    height: 44px;\n    width: 100%;\n  }\n  \n  .loading-field {\n    padding: 1rem;\n    text-align: center;\n    color: #6b7280;\n    font-size: 0.875rem;\n    background: #f9fafb;\n    border-radius: 8px;\n    border: 1px dashed #d1d5db;\n  }\n  \n  /* Submit button */\n  .form-actions {\n    margin-top: 2rem;\n    display: flex;\n    justify-content: center;\n  }\n  \n  .submit-button {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 1rem 2rem;\n    background: #2563eb;\n    color: white;\n    border: none;\n    border-radius: 8px;\n    font-size: 1rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    min-height: 44px;\n    min-width: 120px;\n  }\n  \n  .submit-button:hover:not(:disabled) {\n    background: #1d4ed8;\n    transform: translateY(-1px);\n    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);\n  }\n  \n  .submit-button:disabled {\n    background: #9ca3af;\n    cursor: not-allowed;\n    transform: none;\n    box-shadow: none;\n  }\n  \n  .submit-spinner {\n    width: 1rem;\n    height: 1rem;\n    border: 2px solid transparent;\n    border-top: 2px solid currentColor;\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n    margin-right: 0.5rem;\n  }\n  \n  /* Mobile optimizations for Argentina */\n  @media (max-width: 640px) {\n    .progressive-form {\n      padding: 0;\n    }\n    \n    .form-progress.mobile-optimized {\n      position: sticky;\n      top: 0;\n      z-index: 10;\n      margin: -1rem -1rem 1rem -1rem;\n      border-radius: 0;\n      border-left: none;\n      border-right: none;\n    }\n    \n    .field-input {\n      font-size: 16px; /* Prevent zoom on iOS */\n      padding: 1rem;\n    }\n    \n    .submit-button {\n      width: 100%;\n      margin: 0;\n    }\n  }\n  \n  /* Animations */\n  @keyframes skeleton-pulse {\n    0% {\n      background-position: -200% 0;\n    }\n    100% {\n      background-position: 200% 0;\n    }\n  }\n  \n  @keyframes spin {\n    to {\n      transform: rotate(360deg);\n    }\n  }\n  \n  /* Accessibility improvements */\n  @media (prefers-reduced-motion: reduce) {\n    .skeleton {\n      animation: none;\n      background: #f0f0f0;\n    }\n    \n    .submit-spinner {\n      animation: none;\n    }\n    \n    .progress-fill {\n      transition: none;\n    }\n  }\n  \n  /* High contrast mode */\n  @media (prefers-contrast: high) {\n    .field-input {\n      border-width: 2px;\n      border-color: #000;\n    }\n    \n    .field-input:focus {\n      border-color: #000;\n      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);\n    }\n    \n    .submit-button {\n      background: #000;\n      border: 2px solid #000;\n    }\n  }\n</style>"