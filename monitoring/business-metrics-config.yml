# ============================================================================
# BarberPro Business-Critical Monitoring Configuration
# Comprehensive monitoring for booking success and payment failures
# ============================================================================

global:
  scrape_interval: 10s
  evaluation_interval: 10s
  external_labels:
    monitor: 'barberpro-business'
    region: 'argentina'
    environment: 'production'

# Business-Critical Alert Rules
groups:
  # Critical Business Metrics
  - name: barberpro.business_critical
    interval: 30s
    rules:
      # Booking Success Rate (Critical for Revenue)
      - alert: BookingSuccessRateCritical
        expr: |
          (
            rate(booking_completed_total[5m]) / 
            (rate(booking_completed_total[5m]) + rate(booking_failed_total[5m]))
          ) < 0.90
        for: 2m
        labels:
          severity: critical
          team: product
          service: booking
          impact: high_revenue
          priority: p1
        annotations:
          summary: "Critical: Booking success rate below 90%"
          description: |
            Booking success rate is {{ $value | humanizePercentage }} in the last 5 minutes.
            This directly impacts revenue and customer experience.
            Expected: >90%, Current: {{ $value | humanizePercentage }}
          runbook_url: "https://docs.barberpro.com.ar/runbooks/booking-failure"
          dashboard_url: "https://grafana.barberpro.com.ar/d/business/business-metrics"
          escalation_path: "product-team -> engineering-lead -> cto"

      # Payment Success Rate (Revenue Critical)
      - alert: PaymentSuccessRateCritical
        expr: |
          (
            rate(payment_successful_total{provider="mercadopago"}[5m]) /
            (rate(payment_successful_total{provider="mercadopago"}[5m]) + rate(payment_failed_total{provider="mercadopago"}[5m]))
          ) < 0.95
        for: 1m
        labels:
          severity: critical
          team: finance
          service: payments
          provider: mercadopago
          impact: direct_revenue_loss
          priority: p0
        annotations:
          summary: "URGENT: MercadoPago payment success rate below 95%"
          description: |
            MercadoPago payment success rate dropped to {{ $value | humanizePercentage }}.
            This is causing direct revenue loss for Argentine customers.
            Every minute of delay costs money.
          runbook_url: "https://docs.barberpro.com.ar/runbooks/payment-failure"
          escalation_path: "finance-team -> engineering-lead -> cto -> ceo"

      # Business Hour Revenue Anomaly
      - alert: RevenueAnomalyBusinessHours
        expr: |
          (
            rate(payment_amount_total[1h]) < 
            (avg_over_time(rate(payment_amount_total[1h])[7d:1h]) * 0.7)
          ) and on() (
            hour() >= 9 and hour() <= 18 and
            day_of_week() >= 1 and day_of_week() <= 6
          )
        for: 30m
        labels:
          severity: warning
          team: business
          service: revenue
          impact: revenue_loss
          timezone: argentina
          priority: p2
        annotations:
          summary: "Revenue anomaly during Argentina business hours"
          description: |
            Revenue rate ({{ $value }}) is 30% below normal for this time period.
            This may indicate system issues affecting customer bookings.
            Business hours: 9 AM - 6 PM ART

      # Customer Acquisition Rate Drop
      - alert: NewCustomerAcquisitionDrop
        expr: |
          rate(user_registration_total[1h]) < 
          (avg_over_time(rate(user_registration_total[1h])[7d:1h]) * 0.5)
        for: 2h
        labels:
          severity: warning
          team: marketing
          service: acquisition
          impact: growth
          priority: p3
        annotations:
          summary: "New customer acquisition rate dropped significantly"
          description: |
            New customer registration rate is {{ $value | humanizePercentage }} 
            below the 7-day average, indicating potential issues with the signup flow.

  # Performance Metrics Affecting Business
  - name: barberpro.performance_business_impact
    interval: 15s
    rules:
      # Argentina SLA Violation (Revenue Impact)
      - alert: ArgentinaSLAViolation
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket{country="AR"}[5m])
          ) > 0.200
        for: 3m
        labels:
          severity: warning
          team: devops
          service: api
          sla: argentina
          impact: customer_experience
          priority: p2
        annotations:
          summary: "Argentina SLA violated: Response time > 200ms"
          description: |
            95th percentile response time for Argentina customers is {{ $value | humanizeDuration }}.
            This exceeds our 200ms SLA and may affect conversion rates.
            Customer location: Argentina

      # Booking Form Abandonment Rate
      - alert: BookingFormAbandonmentHigh
        expr: |
          rate(booking_form_abandoned_total[5m]) / 
          rate(booking_form_started_total[5m]) > 0.30
        for: 5m
        labels:
          severity: warning
          team: ux
          service: booking_flow
          impact: conversion
          priority: p3
        annotations:
          summary: "High booking form abandonment rate"
          description: |
            {{ $value | humanizePercentage }} of users are abandoning the booking form.
            This suggests UX issues affecting conversion.

  # Real-time Business Health
  - name: barberpro.realtime_business
    interval: 5s
    rules:
      # Active User Sessions Drop
      - alert: ActiveUsersDropCritical
        expr: |
          active_user_sessions < (avg_over_time(active_user_sessions[1h]) * 0.30)
          and on() (
            hour() >= 8 and hour() <= 20
          )
        for: 5m
        labels:
          severity: critical
          team: devops
          service: application
          impact: availability
          priority: p1
        annotations:
          summary: "Critical drop in active user sessions"
          description: |
            Active user sessions dropped to {{ $value }}, which is 70% below 
            the hourly average. This may indicate application issues.

      # Real-time Booking Rate
      - alert: RealTimeBookingRateZero
        expr: |
          rate(booking_completed_total[2m]) == 0
          and on() (
            hour() >= 9 and hour() <= 18 and
            day_of_week() >= 1 and day_of_week() <= 5
          )
        for: 10m
        labels:
          severity: critical
          team: product
          service: booking
          impact: revenue
          priority: p1
        annotations:
          summary: "ZERO bookings completed in business hours"
          description: |
            No successful bookings in the last 10 minutes during business hours.
            This requires immediate investigation.

  # Provider-specific Metrics
  - name: barberpro.provider_health
    interval: 30s
    rules:
      # Provider Availability Issues
      - alert: ProviderAvailabilityLow
        expr: |
          (
            sum(provider_available_slots_total) / 
            sum(provider_total_slots_total)
          ) < 0.20
        for: 15m
        labels:
          severity: warning
          team: operations
          service: provider_management
          impact: booking_capacity
          priority: p3
        annotations:
          summary: "Low provider availability across platform"
          description: |
            Only {{ $value | humanizePercentage }} of provider slots are available.
            This may limit booking capacity and affect revenue.

      # Provider Response Time to Bookings
      - alert: ProviderResponseTimeSlow
        expr: |
          histogram_quantile(0.75, 
            rate(provider_booking_response_duration_seconds_bucket[30m])
          ) > 3600
        for: 20m
        labels:
          severity: warning
          team: operations
          service: provider_workflow
          impact: customer_experience
          priority: p3
        annotations:
          summary: "Providers taking too long to respond to bookings"
          description: |
            75% of providers are taking longer than 1 hour to respond to bookings.
            Current median response time: {{ $value | humanizeDuration }}

  # Financial Metrics
  - name: barberpro.financial_health
    interval: 60s
    rules:
      # Transaction Volume Anomaly
      - alert: TransactionVolumeAnomalyLow
        expr: |
          sum(rate(payment_amount_total[1h])) < 
          (avg_over_time(sum(rate(payment_amount_total[1h]))[7d:1h]) * 0.60)
        for: 2h
        labels:
          severity: warning
          team: finance
          service: transactions
          impact: revenue
          priority: p2
        annotations:
          summary: "Transaction volume significantly below normal"
          description: |
            Hourly transaction volume is {{ $value | humanizePercentage }} 
            below the 7-day average. Investigate payment flow issues.

      # Average Transaction Value Drop
      - alert: AverageTransactionValueDrop
        expr: |
          (
            sum(rate(payment_amount_total[1h])) / 
            sum(rate(payment_count_total[1h]))
          ) < (
            avg_over_time(
              sum(rate(payment_amount_total[1h])) / 
              sum(rate(payment_count_total[1h]))
            [7d:1h]) * 0.80
          )
        for: 3h
        labels:
          severity: warning
          team: finance
          service: pricing
          impact: revenue
          priority: p3
        annotations:
          summary: "Average transaction value dropped significantly"
          description: |
            Average transaction value dropped {{ $value | humanizePercentage }} 
            below normal levels. May indicate pricing or service mix changes.

  # Customer Experience Metrics
  - name: barberpro.customer_experience
    interval: 30s
    rules:
      # Customer Support Ticket Spike
      - alert: SupportTicketSpike
        expr: |
          rate(support_ticket_created_total[1h]) > 
          (avg_over_time(rate(support_ticket_created_total[1h])[7d:1h]) * 2)
        for: 30m
        labels:
          severity: warning
          team: support
          service: customer_support
          impact: customer_satisfaction
          priority: p2
        annotations:
          summary: "Customer support ticket creation spiked"
          description: |
            Support ticket creation rate is {{ $value }} times higher than normal.
            This may indicate widespread issues affecting customers.

      # Mobile App Crash Rate
      - alert: MobileAppCrashRateHigh
        expr: |
          rate(mobile_app_crash_total[30m]) / 
          rate(mobile_app_session_total[30m]) > 0.05
        for: 15m
        labels:
          severity: warning
          team: mobile
          service: mobile_app
          impact: customer_experience
          platform: mobile
          priority: p2
        annotations:
          summary: "Mobile app crash rate exceeds threshold"
          description: |
            Mobile app crash rate is {{ $value | humanizePercentage }}, 
            affecting customer experience on mobile devices.

# Notification Templates
notification_templates:
  - name: business_critical
    title: "🚨 BarberPro Business Critical Alert"
    message: |
      **Alert:** {{ .GroupLabels.alertname }}
      **Severity:** {{ .GroupLabels.severity }}
      **Impact:** {{ .GroupLabels.impact }}
      **Service:** {{ .GroupLabels.service }}
      
      **Description:** {{ .Annotations.description }}
      
      **Immediate Actions Required:**
      1. Check the runbook: {{ .Annotations.runbook_url }}
      2. View dashboard: {{ .Annotations.dashboard_url }}
      3. Follow escalation path: {{ .Annotations.escalation_path }}
      
      **Business Impact:** This alert directly affects {{ .GroupLabels.impact }}
    
  - name: performance_warning
    title: "⚠️ BarberPro Performance Warning"
    message: |
      **Performance Alert:** {{ .GroupLabels.alertname }}
      **Service:** {{ .GroupLabels.service }}
      **SLA:** {{ .GroupLabels.sla }}
      
      **Description:** {{ .Annotations.description }}
      
      **Recommended Actions:**
      - Monitor the situation closely
      - Check system resources
      - Review recent deployments
      
      **Customer Impact:** {{ .GroupLabels.impact }}